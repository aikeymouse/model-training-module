<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Training Module</title>
    <link rel="stylesheet" href="css/training-module.css">
</head>

<body>
    <!-- Main Interface -->
    <div class="mt-main-interface">
        <h1>Model Training Module</h1>
        <button id="mt-open-model-modal-btn" class="btn-primary">Manage Models</button>
    </div>

    <!-- This file now contains only the modal components that get injected into integrating applications -->
    <!-- The standalone UI has been moved to the Go example app -->

    <!-- Model Info Modal -->
    <!-- Notification Container -->
    <div id="mt-notification-container"></div>

    <div id="mt-model-info-modal" class="mt-modal-overlay" style="display: none;">
        <div class="mt-modal-content">
            <span class="mt-close-button">&times;</span>
            <div class="mt-modal-header">
                <h3>Model Training Pipeline</h3>
            </div>
            <div class="mt-training-controls">
                <div id="mt-training-progress-indicator" class="mt-progress-indicator">
                    <!-- Progress steps will be dynamically generated -->
                </div>
                <div class="mt-modal-actions">
                    <div id="mt-dynamic-controls">
                        <!-- Dynamic controls will be generated based on pipeline config -->
                    </div>
                    <div class="mt-action-buttons">
                        <button id="mt-train-model-btn" class="mt-train-model-btn">Train New Model</button>
                        <button id="mt-configure-pipeline-btn" class="mt-configure-pipeline-btn">Configure
                            Pipeline</button>
                    </div>
                </div>
                <div class="mt-test-actions">
                    <button id="mt-manage-dataset-btn" class="mt-manage-dataset-btn">Manage Dataset</button>
                    <button id="mt-test-model-btn" class="mt-test-model-btn">Test Model</button>
                </div>
            </div>
            <div class="mt-modal-columns-container">
                <div id="mt-model-list-column" class="mt-modal-column">
                    <div id="mt-model-list-container">
                        <!-- Model list will be populated by JavaScript -->
                    </div>
                </div>
                <div id="mt-script-log-column" class="mt-modal-column">
                    <div id="mt-script-log-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Configuration Modal -->
    <div id="mt-pipeline-config-modal" class="mt-modal-overlay" style="display: none;">
        <div class="mt-modal-content mt-pipeline-config-content">
            <span class="mt-close-button" id="mt-close-pipeline-config">&times;</span>
            <div class="mt-modal-header">
                <h3>Configure Training Pipeline</h3>
            </div>
            <div class="mt-pipeline-config-body">
                <div class="mt-config-section">
                    <h4>Pipeline Stages</h4>
                    <div id="mt-stages-container">
                        <!-- Stages will be dynamically generated -->
                    </div>

                    <!-- Add New Stage Form -->
                    <div id="mt-add-stage-form" class="mt-add-stage-form" style="display: none;">
                        <h5>Add New Stage</h5>
                        <div class="mt-form-row">
                            <div class="mt-form-group">
                                <label for="mt-stage-id-input">Stage ID:</label>
                                <input type="text" id="mt-stage-id-input" placeholder="e.g., preprocess" required>
                            </div>
                            <div class="mt-form-group">
                                <label for="mt-stage-name-input">Stage Name:</label>
                                <input type="text" id="mt-stage-name-input" placeholder="e.g., Data Preprocessing"
                                    required>
                            </div>
                        </div>
                        <div class="mt-form-group">
                            <label for="mt-stage-description-input">Description:</label>
                            <input type="text" id="mt-stage-description-input"
                                placeholder="e.g., Preprocess training data" required>
                        </div>
                        <div class="mt-form-group">
                            <label for="mt-stage-script-input">Script Path:</label>
                            <input type="text" id="mt-stage-script-input"
                                placeholder="e.g., training_yolov8/preprocess.py" required>
                        </div>
                        <div class="mt-form-group">
                            <label for="mt-stage-args-input">Arguments (comma-separated):</label>
                            <input type="text" id="mt-stage-args-input"
                                placeholder="e.g., --input, {data_path}, --output, ./processed">
                        </div>
                        <div class="mt-form-group">
                            <label>
                                <input type="checkbox" id="mt-stage-enabled-input" checked>
                                Enabled by default
                            </label>
                        </div>
                        <div class="mt-form-group">
                            <label>
                                <input type="checkbox" id="mt-stage-optional-input">
                                Optional stage
                            </label>
                        </div>
                        <div class="mt-form-actions">
                            <button type="button" id="mt-save-stage-btn" class="mt-save-btn">Save Stage</button>
                            <button type="button" id="mt-cancel-stage-btn" class="mt-cancel-btn">Cancel</button>
                        </div>
                    </div>

                    <button id="mt-add-stage-btn" class="mt-add-stage-btn">Add Stage</button>
                </div>
                <div class="mt-config-section">
                    <h4>Variables</h4>
                    <div id="mt-variables-container">
                        <!-- Variables will be dynamically generated -->
                    </div>

                    <!-- Add New Variable Form -->
                    <div id="mt-add-variable-form" class="mt-add-variable-form" style="display: none;">
                        <h5>Add New Variable</h5>
                        <div class="mt-form-row">
                            <div class="mt-form-group">
                                <label for="mt-variable-key-input">Variable Key:</label>
                                <input type="text" id="mt-variable-key-input" placeholder="e.g., batch_size" required>
                            </div>
                            <div class="mt-form-group">
                                <label for="mt-variable-label-input">Label:</label>
                                <input type="text" id="mt-variable-label-input" placeholder="e.g., Batch Size" required>
                            </div>
                        </div>
                        <div class="mt-form-row">
                            <div class="mt-form-group">
                                <label for="mt-variable-type-select">Variable Type:</label>
                                <select id="mt-variable-type-select" required>
                                    <option value="">Select Type...</option>
                                    <option value="number">Number</option>
                                    <option value="text">Text</option>
                                    <option value="selector">Selector</option>
                                </select>
                            </div>
                            <div class="mt-form-group">
                                <label for="mt-variable-default-input">Default Value:</label>
                                <input type="text" id="mt-variable-default-input" placeholder="e.g., 32">
                            </div>
                        </div>
                        <div id="mt-number-constraints" class="mt-form-row" style="display: none;">
                            <div class="mt-form-group">
                                <label for="mt-variable-min-input">Minimum Value:</label>
                                <input type="number" id="mt-variable-min-input" placeholder="e.g., 1">
                            </div>
                            <div class="mt-form-group">
                                <label for="mt-variable-max-input">Maximum Value:</label>
                                <input type="number" id="mt-variable-max-input" placeholder="e.g., 1000">
                            </div>
                        </div>
                        <div id="mt-selector-options" class="mt-form-row" style="display: none;">
                            <div class="mt-form-group">
                                <label for="mt-variable-options-input">Options (comma-separated):</label>
                                <input type="text" id="mt-variable-options-input"
                                    placeholder="e.g., option1, option2, option3">
                                <small>Enter available options separated by commas</small>
                            </div>
                        </div>
                        <div class="mt-form-group">
                            <label>
                                <input type="checkbox" id="mt-variable-display-input">
                                Hidden
                            </label>
                        </div>
                        <div class="mt-form-actions">
                            <button type="button" id="mt-save-variable-btn" class="mt-save-btn">Save Variable</button>
                            <button type="button" id="mt-cancel-variable-btn" class="mt-cancel-btn">Cancel</button>
                        </div>
                    </div>

                    <button id="mt-add-variable-btn" class="mt-add-variable-btn">Add Variable</button>
                </div>
                <div class="mt-config-actions">
                    <button id="mt-save-pipeline-config-btn" class="mt-save-config-btn">Save Configuration</button>
                    <button id="mt-load-default-config-btn" class="mt-load-default-btn">Load Default</button>
                    <button id="mt-export-config-btn" class="mt-export-config-btn">Export Config</button>
                    <input type="file" id="mt-import-config-input" accept=".json" style="display: none;">
                    <button id="mt-import-config-btn" class="mt-import-config-btn">Import Config</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Report Modal -->
    <div id="mt-model-report-modal" class="mt-modal-overlay" style="display: none;">
        <div class="mt-modal-content mt-report-modal-content">
            <span class="mt-close-button" onclick="closeModelReportModal()">&times;</span>
            <div class="mt-modal-header">
                <h3 id="mt-report-modal-title">Model Training Report</h3>
            </div>
            <div id="mt-report-content-container">
                <iframe id="mt-report-iframe" style="width: 100%; height: 70vh; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Test Model Modal -->
    <div id="mt-test-model-modal" class="mt-modal-overlay" style="display: none;">
        <div class="mt-modal-content mt-test-modal-content">
            <span class="mt-close-button" onclick="closeTestModelModal()">&times;</span>
            <div class="mt-modal-header">
                <h3>Test Model on Image</h3>
            </div>
            <div class="mt-test-model-body">
                <div class="mt-test-model-content">
                    <!-- Combined Image Area -->
                    <div class="mt-test-section">
                        <div class="mt-combined-image-area" id="mt-combined-image-area">
                            <!-- Upload Area -->
                            <div class="mt-file-upload-area" id="mt-file-upload-area">
                                <div class="mt-upload-content">
                                    <div class="mt-upload-icon">📁</div>
                                    <p>Click to select an image or drag and drop</p>
                                    <p class="mt-upload-hint">Supported formats: JPG, PNG, JPEG</p>
                                </div>
                                <input type="file" id="mt-test-image-input" accept="image/*" style="display: none;">
                            </div>

                            <!-- Image Preview -->
                            <div id="mt-selected-image-preview" class="mt-image-preview" style="display: none;">
                                <img id="mt-preview-image" alt="Selected image">
                            </div>

                            <!-- Result Image -->
                            <div id="mt-result-image-container" class="mt-result-image-container"
                                style="display: none;">
                                <img id="mt-result-image" alt="Detection results" class="mt-result-image">
                            </div>
                        </div>
                    </div>

                    <!-- Detection Results Section (Always Visible) -->
                    <div class="mt-test-section">
                        <h4>Detection Results</h4>
                        <div id="mt-test-results-content" class="mt-detection-results-content">
                            <p class="mt-no-results">Select an image and click Detect to see results</p>
                        </div>
                    </div>

                    <!-- Detection Settings -->
                    <div class="mt-test-section">
                        <h4>Detection Settings</h4>
                        <div class="mt-detection-settings">
                            <div class="mt-form-group">
                                <label for="mt-confidence-threshold-input">Confidence Threshold:</label>
                                <input type="number" id="mt-confidence-threshold-input" min="0.01" max="1.0" step="0.01"
                                    value="0.25" placeholder="0.25">
                                <small>Minimum confidence for detections (0.01 - 1.0)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Detect Button -->
                    <div class="mt-test-section">
                        <button id="mt-run-test-btn" class="mt-run-test-btn" disabled>Detect</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Dataset Modal -->
    <div id="mt-manage-dataset-modal" class="mt-modal-overlay" style="display: none;">
        <div class="mt-modal-content mt-dataset-modal-content">
            <span class="mt-close-button" onclick="closeManageDatasetModal()">&times;</span>
            <div class="mt-modal-header">
                <h3>Manage Dataset</h3>
            </div>

            <!-- Dataset Tabs -->
            <div class="mt-dataset-tabs">
                <label class="mt-switch-label">
                    <input type="radio" name="dataset-tab" value="synthetic" checked>
                    <span class="mt-radio-text">Synthetic Dataset</span>
                </label>
                <label class="mt-switch-label">
                    <input type="radio" name="dataset-tab" value="custom">
                    <span class="mt-radio-text">Custom Dataset</span>
                </label>
            </div>

            <div class="mt-dataset-body">
                <!-- Synthetic Dataset Tab Content -->
                <div id="mt-synthetic-tab" class="mt-tab-content active">
                    <div class="mt-dataset-info">
                        <div class="mt-dataset-stats">
                            <div class="mt-dataset-stats-left">
                                Images total: <span id="mt-dataset-total-count">Loading...</span>
                            </div>
                            <div class="mt-dataset-stats-right">
                                <label class="mt-bbox-toggle">
                                    <input type="checkbox" id="mt-show-bboxes" />
                                    <span class="mt-bbox-toggle-text">Show Bounding Boxes</span>
                                </label>
                                <span class="mt-dataset-pagination-info">
                                    Showing <span id="mt-dataset-current-range">1-25</span>
                                    (Page <span id="mt-dataset-current-page">1</span> of <span
                                        id="mt-dataset-total-pages">1</span>)
                                </span>
                                <div class="mt-dataset-pagination">
                                    <button id="mt-dataset-prev-page" class="mt-pagination-btn" disabled>←
                                        Previous</button>
                                    <button id="mt-dataset-next-page" class="mt-pagination-btn">Next →</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Thumbnails Grid -->
                    <div class="mt-dataset-thumbnails">
                        <div id="mt-thumbnails-grid" class="mt-thumbnails-grid">
                            <!-- Thumbnails will be loaded here -->
                        </div>
                    </div>

                    <!-- Image Carousel -->
                    <div class="mt-dataset-carousel-container">
                        <div class="mt-carousel-navigation">
                            <button id="mt-carousel-prev" class="mt-carousel-btn" disabled>‹</button>
                            <span class="mt-carousel-indicator">
                                <span id="mt-carousel-current">1</span> / <span id="mt-carousel-total">25</span>
                            </span>
                            <button id="mt-carousel-next" class="mt-carousel-btn">›</button>
                        </div>

                        <div class="mt-dataset-image-container">
                            <img id="mt-dataset-current-image" alt="Dataset image" style="display: none;">
                            <div id="mt-dataset-loading" class="mt-loading-indicator">Loading images...</div>
                            <div id="mt-dataset-no-images" class="mt-no-content" style="display: none;">
                                No dataset images found. Generate a dataset first.
                            </div>
                            <!-- Zoomed bounding box preview -->
                            <div id="mt-bbox-zoom-container" class="mt-bbox-zoom-container" style="display: none;">
                                <canvas id="mt-bbox-zoom-canvas"></canvas>
                                <div class="mt-bbox-zoom-label">100x Zoom</div>
                            </div>
                        </div>

                        <div class="mt-dataset-image-info">
                            <div class="mt-image-details">
                                <span id="mt-current-image-name">image.jpg</span>
                                <span id="mt-current-image-size">1024x768</span>
                            </div>
                            <div class="mt-image-actions">
                                <button id="mt-delete-current-image" class="mt-delete-btn">Delete Image</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Dataset Tab Content -->
                <div id="mt-custom-tab" class="mt-tab-content">
                    <!-- Stats Header -->
                    <div class="mt-dataset-info">
                        <div class="mt-dataset-stats">
                            <div class="mt-dataset-stats-left">
                                Backgrounds: <span id="mt-custom-backgrounds-count">Loading...</span> | 
                                Targets: <span id="mt-custom-cursors-count">Loading...</span> | 
                                Selected Target: <span id="mt-selected-target-name">None</span>
                            </div>
                            <div class="mt-dataset-stats-right">
                                <div class="mt-dataset-generation">
                                    <label for="mt-dataset-count">Images:</label>
                                    <input type="number" id="mt-dataset-count" min="10" step="10" value="100" disabled>
                                    <button id="mt-generate-dataset-btn" disabled>Generate Dataset</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Target Images Section -->
                    <div class="mt-custom-cursors-section">
                        <div class="mt-section-header">
                            <h4>Target Images</h4>
                            <button id="mt-upload-cursor" class="mt-upload-btn">Upload Target</button>
                        </div>                        
                        <div class="mt-dataset-thumbnails">
                            <div id="mt-custom-cursors-grid" class="mt-custom-cursors-grid">
                                <div id="mt-custom-cursors-loading" class="mt-loading-message">Loading target images...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Background Images Section -->
                    <div class="mt-dataset-carousel-container">
                        <div class="mt-carousel-navigation">
                            <button id="mt-custom-carousel-prev" class="mt-carousel-btn" disabled>‹</button>
                            <span class="mt-carousel-indicator">
                                Background <span id="mt-custom-carousel-current">1</span> / <span id="mt-custom-carousel-total">1</span>
                            </span>
                            <button id="mt-custom-carousel-next" class="mt-carousel-btn">›</button>
                        </div>
                        
                        <div class="mt-dataset-image-container">
                            <img id="mt-custom-current-image" alt="Background image" style="display: none;">
                            <div id="mt-custom-loading" class="mt-loading-indicator">Loading background images...</div>
                            <div id="mt-custom-no-images" class="mt-no-content" style="display: none;">
                                No background images found. Upload some backgrounds to get started.
                            </div>
                        </div>

                        <div class="mt-dataset-image-info">
                            <div class="mt-image-details">
                                <span id="mt-custom-image-name">background.jpg</span>
                                <span id="mt-custom-image-size">1024x768</span>
                            </div>
                            <div class="mt-image-actions">
                                <button id="mt-upload-background" class="mt-upload-btn">Upload Background</button>
                                <button id="mt-delete-custom-background" class="mt-delete-btn">Delete Background</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="module" src="js/model.js"></script>
</body>

</html>